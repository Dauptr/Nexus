<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <meta name="description" content="NEXUS OS - AI-powered cyberpunk web operating system">
  <title>NEXUS OS V14.2 | Cyberpunk Operating System</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§¬</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Rajdhani', sans-serif; background: #000; color: #e0e0e0; }
    input, textarea, select { font-size: 16px !important; }
    input::placeholder, textarea::placeholder { color: rgba(150, 150, 180, 0.7) !important; }
    input:focus, textarea:focus { border-color: #00f0ff !important; outline: none; box-shadow: 0 0 20px rgba(0, 240, 255, 0.3); }
    
    @keyframes gradient { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 15px #ff00aa, 0 0 30px #8b00ff; } 50% { box-shadow: 0 0 25px #ff00aa, 0 0 50px #8b00ff; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bgMove { 0% { transform: translate(0, 0); } 100% { transform: translate(-50px, -50px); } }
    @keyframes scanline { 0% { top: -100%; } 100% { top: 100%; } }
    @keyframes particleFloat { 0%, 100% { transform: translateY(0) translateX(0); } 25% { transform: translateY(-20px) translateX(10px); } 50% { transform: translateY(-10px) translateX(-10px); } 75% { transform: translateY(-30px) translateX(5px); } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.5); }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #00f0ff, #8b00ff); border-radius: 3px; }
    
    .gradient-text { background: linear-gradient(90deg, #00f0ff, #8b00ff, #ff00aa, #00f0ff); background-size: 300% 100%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradient 3s ease infinite; }
    .glow { animation: glow 2s ease-in-out infinite; }
    .float { animation: float 3s ease-in-out infinite; }
    .pulse { animation: pulse 2s ease-in-out infinite; }
    .slide { animation: slideUp 0.3s ease; }
    .spin { animation: spin 1s linear infinite; }
    
    .live-bg {
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(0, 240, 255, 0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(139, 0, 255, 0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(255, 0, 170, 0.15) 0%, transparent 60%),
        radial-gradient(ellipse at 10% 90%, rgba(0, 255, 136, 0.1) 0%, transparent 40%);
      animation: bgMove 20s linear infinite;
      pointer-events: none;
      z-index: 0;
    }
    
    .grid-overlay {
      position: fixed;
      inset: 0;
      background-image: 
        linear-gradient(rgba(0, 240, 255, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 240, 255, 0.04) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 1;
    }
    
    .scanline {
      position: fixed;
      left: 0;
      right: 0;
      height: 100px;
      background: linear-gradient(transparent, rgba(0, 240, 255, 0.04), transparent);
      animation: scanline 8s linear infinite;
      pointer-events: none;
      z-index: 2;
    }
    
    .particles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 3;
      overflow: hidden;
    }
    
    .particle {
      position: absolute;
      border-radius: 50%;
      animation: particleFloat 15s ease-in-out infinite;
    }
    
    .glass {
      background: rgba(10, 10, 25, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .neon-border {
      border: 1px solid rgba(0, 240, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 240, 255, 0.1), inset 0 0 20px rgba(0, 240, 255, 0.05);
    }
    
    .cyber-card {
      background: rgba(5, 5, 15, 0.7);
      border: 1px solid rgba(0, 240, 255, 0.15);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .cyber-card:hover, .cyber-card:focus {
      border-color: rgba(0, 240, 255, 0.4);
      box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
      transform: translateY(-2px);
      outline: none;
    }
    
    .cyber-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-family: 'Orbitron', sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .cyber-btn:hover, .cyber-btn:focus {
      transform: translateY(-2px);
      box-shadow: 0 5px 25px rgba(0, 240, 255, 0.3);
      outline: none;
    }
    
    .cyber-btn:active {
      transform: translateY(0);
    }
    
    .cyber-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .cyber-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(0, 240, 255, 0.2);
      border-radius: 10px;
      color: #fff;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .cyber-input:focus {
      border-color: #00f0ff;
      box-shadow: 0 0 25px rgba(0, 240, 255, 0.3);
    }
    
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: rgba(0, 240, 255, 0.1);
      border: 1px solid rgba(0, 240, 255, 0.2);
      border-radius: 8px;
      color: #00f0ff;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .back-btn:hover, .back-btn:focus {
      background: rgba(0, 240, 255, 0.2);
      border-color: rgba(0, 240, 255, 0.4);
      outline: none;
    }

    /* Focus visible for accessibility */
    :focus-visible {
      outline: 2px solid #00f0ff;
      outline-offset: 2px;
    }

    /* Loading spinner */
    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
  </style>
</head>
<body>
  <div id="app" style="width:100%;height:100%"></div>
  <script src="https://js.puter.com/v2/" async></script>
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NEXUS OS V14.2 - CYBERPUNK OPERATING SYSTEM - IMPROVED VERSION
    // Security fixes, performance improvements, bug fixes, accessibility
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITY FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const Utils = {
      // Escape HTML to prevent XSS
      escape(str) {
        if (typeof str !== 'string') return str;
        const escapeMap = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#x27;',
          '/': '&#x2F;'
        };
        return str.replace(/[&<>"'/]/g, char => escapeMap[char]);
      },
      
      // Sanitize user input
      sanitize(str) {
        if (typeof str !== 'string') return '';
        return str.trim().slice(0, 10000); // Limit length
      },
      
      // Generate random ID
      generateId() {
        return Math.random().toString(36).substr(2, 9);
      },
      
      // Debounce function
      debounce(fn, delay) {
        let timeoutId;
        return (...args) => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn.apply(this, args), delay);
        };
      },
      
      // Safe JSON parse
      safeJsonParse(str, fallback = null) {
        try {
          return JSON.parse(str);
        } catch {
          return fallback;
        }
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE PERSISTENCE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const Storage = {
      KEY: 'nexus_os_state_v14',
      
      save(state) {
        try {
          const data = {
            user: state.user,
            ideCode: state.ideCode,
            aiMsgs: state.aiMsgs.slice(-20), // Keep last 20 messages
            theme: state.theme
          };
          localStorage.setItem(this.KEY, JSON.stringify(data));
        } catch (e) {
          console.warn('[Storage] Save failed:', e);
        }
      },
      
      load() {
        try {
          const saved = localStorage.getItem(this.KEY);
          if (saved) {
            return Utils.safeJsonParse(saved, {});
          }
        } catch (e) {
          console.warn('[Storage] Load failed:', e);
        }
        return {};
      },
      
      clear() {
        try {
          localStorage.removeItem(this.KEY);
        } catch (e) {
          console.warn('[Storage] Clear failed:', e);
        }
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH MANAGER (Secure credential handling)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const AuthManager = {
      // Obfuscated credential check (better than plaintext, but server-side is ideal)
      // These are base64 encoded for basic obfuscation - NOT encryption
      // In production, ALL auth should be server-side
      _validCredentials: [
        'YWRtaW46ZGF1cHRy',  // admin:dauptr
        'bmV4dXM6bmV4dXMxMjM=', // nexus:nexus123
        'dXNlcjp1c2VyMTIz'  // user:user123
      ],
      
      validate(username, password) {
        // Try server auth first
        return this._serverAuth(username, password).then(success => {
          if (success) return success;
          // Fallback to local validation (for demo/offline)
          return this._localAuth(username, password);
        });
      },
      
      async _serverAuth(username, password) {
        try {
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });
          if (!res.ok) return null;
          const data = await res.json();
          return data.success ? data.user : null;
        } catch {
          return null;
        }
      },
      
      _localAuth(username, password) {
        const encoded = btoa(`${username}:${password}`);
        if (!this._validCredentials.includes(encoded)) return null;
        
        // Determine role based on username
        const roles = {
          'admin': { username: 'admin', displayName: 'Admin', role: 'admin', isPremium: true },
          'nexus': { username: 'nexus', displayName: 'Nexus', role: 'user', isPremium: true },
          'user': { username: 'user', displayName: 'User', role: 'user', isPremium: false }
        };
        return roles[username] || { username, displayName: username, role: 'user', isPremium: false };
      },
      
      createGuestUser() {
        return {
          username: 'guest_' + Utils.generateId().slice(0, 4),
          displayName: 'Guest',
          role: 'guest',
          isPremium: false
        };
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUDIO MANAGER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const AudioManager = {
      audio: null,
      currentStation: null,
      isPlaying: false,
      
      init() {
        if (!this.audio) {
          this.audio = new Audio();
          this.audio.onerror = () => console.warn('[Audio] Playback error');
        }
      },
      
      async play(url) {
        this.init();
        try {
          this.audio.src = url;
          await this.audio.play();
          this.isPlaying = true;
          return true;
        } catch (e) {
          console.warn('[Audio] Play failed:', e);
          this.isPlaying = false;
          return false;
        }
      },
      
      pause() {
        if (this.audio) {
          this.audio.pause();
          this.isPlaying = false;
        }
      },
      
      stop() {
        if (this.audio) {
          this.audio.pause();
          this.audio.src = '';
          this.isPlaying = false;
          this.currentStation = null;
        }
      },
      
      toggle() {
        if (this.isPlaying) {
          this.pause();
        } else if (this.audio && this.audio.src) {
          this.audio.play().then(() => {
            this.isPlaying = true;
          }).catch(() => {});
        }
        return this.isPlaying;
      },
      
      cleanup() {
        this.stop();
        this.audio = null;
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GAME MANAGER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const GameManager = {
      intervals: new Map(),
      timers: new Map(),
      
      setInterval(id, fn, delay) {
        this.clearInterval(id);
        this.intervals.set(id, setInterval(fn, delay));
      },
      
      clearInterval(id) {
        if (this.intervals.has(id)) {
          clearInterval(this.intervals.get(id));
          this.intervals.delete(id);
        }
      },
      
      setTimeout(id, fn, delay) {
        this.clearTimeout(id);
        this.timers.set(id, setTimeout(() => {
          this.timers.delete(id);
          fn();
        }, delay));
      },
      
      clearTimeout(id) {
        if (this.timers.has(id)) {
          clearTimeout(this.timers.get(id));
          this.timers.delete(id);
        }
      },
      
      cleanup() {
        this.intervals.forEach(interval => clearInterval(interval));
        this.timers.forEach(timer => clearTimeout(timer));
        this.intervals.clear();
        this.timers.clear();
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN APPLICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const App = {
      // State
      state: {
        phase: 'boot',
        bootP: 0,
        bootT: 'INITIALIZING',
        user: null,
        app: null,
        note: '',
        time: '',
        online: navigator.onLine,
        // AI
        aiMsgs: [],
        aiLoad: false,
        // Copilot
        copOpen: false,
        copMsgs: [],
        copLoad: false,
        // YouTube
        ytRes: [],
        ytVid: null,
        ytLoad: false,
        // Build
        bldP: 0,
        bldStat: 'idle',
        bldLog: ['[SYSTEM] Build Console Ready'],
        // Radio
        radSt: null,
        radPlay: false,
        radRes: [],
        radLoad: false,
        // Terminal
        termLn: ['[NEXUS] Terminal v14.2 Ready', ''],
        // IDE
        ideCode: '// NEXUS IDE v14.2\nconsole.log("Hello Cyberpunk!");',
        // Art
        artImgs: [],
        artLoad: false,
        // Tools
        toolProg: 0,
        toolInst: null,
        // Admin
        admUsr: [],
        admStat: null,
        admLoad: false,
        // Games
        gameType: null,
        // Snake game
        snake: { body: [[5,5]], dir: [1,0], food: [10,10], score: 0, over: false, speed: 150 },
        // Memory game
        memory: { cards: [], flipped: [], matched: [], moves: 0, done: false },
        // Reaction game
        reaction: { state: 'wait', startTime: 0, score: 0, targetTime: 0 }
      },
      
      // Cached particles (performance fix)
      particles: [],
      
      renderScheduled: false,
      
      // Initialize particles once
      initParticles() {
        const colors = ['#00f0ff', '#8b00ff', '#ff00aa', '#00ff88'];
        this.particles = Array.from({ length: 15 }, () => ({
          x: Math.random() * 100,
          y: Math.random() * 100,
          color: colors[Math.floor(Math.random() * colors.length)],
          delay: Math.random() * 15,
          size: 2 + Math.random() * 4
        }));
      },
      
      // Safe render - batches updates
      render() {
        if (this.renderScheduled) return;
        this.renderScheduled = true;
        requestAnimationFrame(() => {
          this.renderScheduled = false;
          this._doRender();
        });
      },
      
      _doRender() {
        const el = document.getElementById('app');
        if (!el) return;
        const S = this.state;
        const m = window.innerWidth < 768;
        
        // BOOT PHASE
        if (S.phase === 'boot') {
          el.innerHTML = this.renderBoot(m);
          return;
        }
        
        // LOGIN PHASE
        if (S.phase === 'login') {
          el.innerHTML = this.renderLogin(m);
          return;
        }
        
        // DESKTOP PHASE
        el.innerHTML = this.renderDesktop(m);
      },
      
      // Notification helper
      notify(msg) {
        this.state.note = msg;
        this.render();
        setTimeout(() => {
          this.state.note = '';
          this.render();
        }, 2500);
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // RENDER FUNCTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      renderBoot(m) {
        return `
          <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,#000 0%,#050510 50%,#000 100%);position:relative;overflow:hidden">
            <div class="live-bg"></div>
            <div class="grid-overlay"></div>
            <div class="scanline"></div>
            ${this.renderParticles()}
            
            <div class="float" style="position:relative;z-index:10;text-align:center" role="banner">
              <div style="font-size:${m?'50px':'80px'};font-weight:900;font-family:'Orbitron',sans-serif;letter-spacing:10px" class="gradient-text">NEXUS</div>
              <div style="font-size:${m?'12px':'16px'};font-family:'Orbitron',sans-serif;letter-spacing:20px;color:#405060;margin-top:10px">OPERATING SYSTEM</div>
              <div style="font-size:10px;color:#00f0ff;margin-top:20px;letter-spacing:5px">VERSION 14.2 // CYBERPUNK</div>
            </div>
            
            <div style="position:relative;z-index:10;margin-top:60px;width:${m?'280px':'400px'}" role="progressbar" aria-valuenow="${this.state.bootP}" aria-valuemin="0" aria-valuemax="100">
              <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                <span style="font-size:10px;color:#505060;font-family:'JetBrains Mono',monospace;letter-spacing:2px">${Utils.escape(this.state.bootT)}</span>
                <span style="font-size:10px;color:#00f0ff;font-family:'JetBrains Mono',monospace">${this.state.bootP}%</span>
              </div>
              <div style="height:3px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden">
                <div style="width:${this.state.bootP}%;height:100%;background:linear-gradient(90deg,#00f0ff,#8b00ff,#ff00aa);border-radius:3px;transition:width 0.3s"></div>
              </div>
            </div>
            
            ${this.renderCornerFrames()}
          </div>`;
      },
      
      renderLogin(m) {
        return `
          <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden">
            <div class="live-bg"></div>
            <div class="grid-overlay"></div>
            <div class="scanline"></div>
            ${this.renderParticles()}
            
            <div class="glass neon-border" style="width:${m?'340px':'420px'};border-radius:20px;padding:40px;position:relative;z-index:10" role="main">
              <div style="text-align:center;margin-bottom:30px">
                <div style="font-size:48px;font-weight:900;font-family:'Orbitron',sans-serif" class="gradient-text">NEXUS</div>
                <div style="font-size:10px;color:#405060;letter-spacing:10px;margin-top:8px">OPERATING SYSTEM</div>
                <div style="font-size:9px;color:#00f0ff;margin-top:5px">V14.2 CYBERPUNK</div>
              </div>
              
              <form id="login-form" style="display:flex;flex-direction:column;gap:12px" aria-label="Login form">
                <div style="position:relative">
                  <span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#505060;font-size:16px" aria-hidden="true">ğŸ‘¤</span>
                  <input name="username" placeholder="Username" autocomplete="username" class="cyber-input" style="padding-left:42px" aria-label="Username" required>
                </div>
                <div style="position:relative">
                  <span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#505060;font-size:16px" aria-hidden="true">ğŸ”‘</span>
                  <input name="password" type="password" placeholder="Password" autocomplete="current-password" class="cyber-input" style="padding-left:42px" aria-label="Password" required>
                </div>
                <button type="submit" class="cyber-btn" style="background:linear-gradient(135deg,#00f0ff,#8b00ff);color:#000;margin-top:8px">âš¡ ACCESS SYSTEM</button>
              </form>
              
              <div style="display:flex;align-items:center;gap:15px;margin:20px 0">
                <div style="flex:1;height:1px;background:linear-gradient(90deg,transparent,rgba(0,240,255,0.3),transparent)"></div>
                <span style="color:#405060;font-size:10px">OR</span>
                <div style="flex:1;height:1px;background:linear-gradient(90deg,transparent,rgba(0,240,255,0.3),transparent)"></div>
              </div>
              
              <button id="guest-btn" class="cyber-btn" style="width:100%;background:transparent;border:1px solid rgba(139,0,255,0.3);color:#fff">ğŸ§‘ Enter as Guest</button>
              
              <div style="text-align:center;margin-top:20px;font-size:9px;color:#305060">
                Demo accounts available for testing
              </div>
            </div>
          </div>`;
      },
      
      renderDesktop(m) {
        const S = this.state;
        return `
          <div style="width:100%;height:100%;display:flex;flex-direction:column;position:relative;overflow:hidden">
            <div class="live-bg"></div>
            <div class="grid-overlay"></div>
            <div class="scanline"></div>
            ${this.renderParticles()}
            
            <!-- Header -->
            <header class="glass" style="padding:10px 20px;border-bottom:1px solid rgba(0,240,255,0.15);display:flex;justify-content:space-between;align-items:center;position:relative;z-index:100" role="banner">
              <div style="display:flex;align-items:center;gap:15px">
                <span style="font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700" class="gradient-text">NEXUS</span>
                <span style="font-size:9px;color:#405060">V14.2</span>
                <span style="font-size:12px;color:#607090;font-family:'JetBrains Mono',monospace" aria-live="polite">${Utils.escape(S.time)}</span>
                <div style="padding:3px 10px;border-radius:20px;font-size:9px;background:${S.online?'rgba(0,255,136,0.15)':'rgba(255,0,85,0.15)'};color:${S.online?'#00ff88':'#ff0055'};border:1px solid ${S.online?'rgba(0,255,136,0.3)':'rgba(255,0,85,0.3)'}" aria-label="${S.online?'Online':'Offline'}">${S.online?'â— ONLINE':'â—‹ OFFLINE'}</div>
              </div>
              <div style="display:flex;align-items:center;gap:12px">
                ${S.radPlay?'<span style="font-size:11px;color:#ffcc00" aria-label="Radio playing">ğŸ“» <span class="pulse">â—</span></span>':''}
                <span style="font-size:12px;color:#a0a0a0">${Utils.escape(S.user?.displayName||'Guest')}</span>
                ${S.user?.role==='admin'?'<span style="padding:3px 8px;border-radius:4px;font-size:9px;background:linear-gradient(135deg,rgba(255,0,170,0.2),rgba(139,0,255,0.2));color:#ff00aa;border:1px solid rgba(255,0,170,0.3)">ğŸ‘‘ ADMIN</span>':''}
                ${S.user?.isPremium?'<span style="padding:3px 8px;border-radius:4px;font-size:9px;background:rgba(255,204,0,0.15);color:#ffcc00;border:1px solid rgba(255,204,0,0.3)">â­</span>':''}
                <button id="logout-btn" class="cyber-btn" style="padding:6px 12px;background:rgba(255,0,85,0.15);color:#ff0055;border:1px solid rgba(255,0,85,0.3);font-size:9px" aria-label="Logout">LOGOUT</button>
              </div>
            </header>
            
            <!-- Main -->
            <main style="flex:1;display:flex;overflow:hidden;position:relative;z-index:10" role="main">
              <div style="flex:1;padding:15px;overflow-y:auto">${!S.app?this.renderAppGrid():this.renderApp(m)}</div>
              ${S.copOpen?this.renderCopilot():''}
            </main>
            
            <!-- Notification -->
            ${S.note?`<div class="slide glass" style="position:fixed;top:70px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:12px;border:1px solid rgba(0,240,255,0.3);font-size:13px;color:#fff;z-index:1000" role="alert" aria-live="assertive">${Utils.escape(S.note)}</div>`:''}
            
            <!-- Floating Copilot Button -->
            ${!S.copOpen&&S.app?`<button id="copilot-toggle" class="glow" style="position:fixed;bottom:25px;right:25px;width:55px;height:55px;background:linear-gradient(135deg,#ff00aa,#8b00ff);border:none;border-radius:50%;cursor:pointer;font-size:24px;z-index:100" aria-label="Open AI Copilot">ğŸ’¡</button>`:''}
            
            <!-- Status Bar -->
            <footer class="glass" style="padding:6px 20px;border-top:1px solid rgba(0,240,255,0.1);display:flex;justify-content:space-between;font-size:10px;color:#405060;font-family:'JetBrains Mono',monospace;position:relative;z-index:100" role="contentinfo">
              <div style="display:flex;gap:20px"><span>NEXUS OS V14.2</span><span>CYBERPUNK</span></div>
              <div style="display:flex;gap:15px"><span>AI: <span style="color:#00ff88">READY</span></span><span>MEM: <span style="color:#00f0ff">OK</span></span></div>
            </footer>
          </div>`;
      },
      
      renderParticles() {
        const particles = this.particles.map(p => 
          `<div class="particle" style="left:${p.x}%;top:${p.y}%;width:${p.size}px;height:${p.size}px;background:${p.color};box-shadow:0 0 ${p.size*2}px ${p.color};animation-delay:-${p.delay}s"></div>`
        ).join('');
        return `<div class="particles" aria-hidden="true">${particles}</div>`;
      },
      
      renderCornerFrames() {
        return `
          <div style="position:absolute;top:20px;left:20px;width:50px;height:50px;border-left:2px solid #00f0ff;border-top:2px solid #00f0ff;opacity:0.5" aria-hidden="true"></div>
          <div style="position:absolute;top:20px;right:20px;width:50px;height:50px;border-right:2px solid #8b00ff;border-top:2px solid #8b00ff;opacity:0.5" aria-hidden="true"></div>
          <div style="position:absolute;bottom:20px;left:20px;width:50px;height:50px;border-left:2px solid #ff00aa;border-bottom:2px solid #ff00aa;opacity:0.5" aria-hidden="true"></div>
          <div style="position:absolute;bottom:20px;right:20px;width:50px;height:50px;border-right:2px solid #00f0ff;border-bottom:2px solid #00f0ff;opacity:0.5" aria-hidden="true"></div>`;
      },
      
      renderAppGrid() {
        const S = this.state;
        const apps = [
          {id:'ai',n:'AI Chat',i:'ğŸ¤–',d:'Smart AI'},
          {id:'yt',n:'YouTube',i:'â–¶ï¸',d:'Videos'},
          {id:'bld',n:'Build',i:'ğŸ”§',d:'Console'},
          {id:'rad',n:'Radio',i:'ğŸ“»',d:'30K+ Stations'},
          {id:'term',n:'Terminal',i:'âŒ¨ï¸',d:'Commands'},
          {id:'ide',n:'IDE',i:'ğŸ’»',d:'Code Editor'},
          {id:'art',n:'Art',i:'ğŸ¨',d:'AI Images'},
          {id:'game',n:'Games',i:'ğŸ®',d:'Play'},
          {id:'tool',n:'Tools',i:'ğŸ› ï¸',d:'Install'},
          {id:'set',n:'Settings',i:'âš™ï¸',d:'Config'}
        ];
        if (S.user?.role === 'admin') apps.unshift({id:'adm',n:'Admin',i:'ğŸ‘‘',d:'Management'});
        
        return `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:12px" role="navigation" aria-label="Application grid">
          ${apps.map(a=>`
            <button class="app-card cyber-card" data-app="${a.id}" style="padding:20px 12px;text-align:center;cursor:pointer;border:none;width:100%" role="menuitem" aria-label="${a.n} - ${a.d}">
              <div style="font-size:36px;margin-bottom:10px" aria-hidden="true">${a.i}</div>
              <div style="font-family:'Orbitron',sans-serif;font-size:10px;color:#fff;letter-spacing:1px">${Utils.escape(a.n)}</div>
              <div style="font-size:9px;color:#405060;margin-top:4px">${Utils.escape(a.d)}</div>
            </button>
          `).join('')}
        </div>`;
      },
      
      renderApp(m) {
        const S = this.state;
        const hdr = (i,t) => `<div style="display:flex;align-items:center;gap:15px;margin-bottom:15px">
          <button class="back-btn" id="back-btn" aria-label="Go back">â† Back</button>
          <span style="font-size:24px" aria-hidden="true">${i}</span>
          <span style="font-family:'Orbitron',sans-serif;font-size:14px;color:#fff">${Utils.escape(t)}</span>
        </div>`;
        
        switch(S.app) {
          case 'ai': return this.renderAIApp(hdr, m);
          case 'yt': return this.renderYouTubeApp(hdr, m);
          case 'bld': return this.renderBuildApp(hdr, m);
          case 'rad': return this.renderRadioApp(hdr, m);
          case 'term': return this.renderTerminalApp(hdr, m);
          case 'ide': return this.renderIDEApp(hdr, m);
          case 'art': return this.renderArtApp(hdr, m);
          case 'game': return this.renderGamesApp(hdr, m);
          case 'tool': return this.renderToolsApp(hdr, m);
          case 'adm': return this.renderAdminApp(hdr, m);
          case 'set': return this.renderSettingsApp(hdr, m);
          default: return '<div style="text-align:center;padding:50px;color:#405060">Select an app</div>';
        }
      },
      
      renderAIApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
          ${hdr('ğŸ¤–','AI Chat')}
          <div id="ai-messages" style="flex:1;overflow-y:auto;padding:10px" role="log" aria-live="polite" aria-label="Chat messages">
            ${S.aiMsgs.length===0?'<div style="text-align:center;padding:40px;color:#405060"><div style="font-size:48px" aria-hidden="true">ğŸ¤–</div><div style="margin-top:15px;color:#607090">Start a conversation</div></div>':''}
            ${S.aiMsgs.map(msg=>`
              <div style="margin-bottom:15px;display:flex;gap:12px;align-items:flex-start" role="article">
                <div style="width:36px;height:36px;border-radius:10px;background:${msg.r==='user'?'linear-gradient(135deg,#8b00ff,#ff00aa)':'linear-gradient(135deg,#00f0ff,#00a0ff)'};display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0" aria-hidden="true">${msg.r==='user'?'ğŸ‘¤':'ğŸ¤–'}</div>
                <div style="flex:1;background:rgba(${msg.r==='user'?'139,0,255':'0,240,255'},0.08);border-radius:12px;padding:12px 16px;font-size:13px;line-height:1.6;white-space:pre-wrap;border:1px solid rgba(${msg.r==='user'?'139,0,255':'0,240,255'},0.15)">${Utils.escape(msg.c)}</div>
              </div>
            `).join('')}
            ${S.aiLoad?'<div style="text-align:center;color:#607090;padding:10px"><span class="pulse">â³</span> Thinking...</div>':''}
          </div>
          <div style="padding:10px;border-top:1px solid rgba(0,240,255,0.1);display:flex;gap:10px">
            <input id="ai-input" placeholder="Ask NEXUS AI..." class="cyber-input" style="flex:1" aria-label="Type your message" ${S.aiLoad?'disabled':''}>
            <button id="ai-send" class="cyber-btn" style="background:linear-gradient(135deg,#00f0ff,#00a0ff);color:#000" ${S.aiLoad?'disabled':''}>SEND</button>
          </div>
        </div>`;
      },
      
      renderYouTubeApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
          ${hdr('â–¶ï¸','YouTube')}
          <div style="display:flex;gap:10px;margin-bottom:15px">
            <input id="yt-input" placeholder="Search videos..." class="cyber-input" style="flex:1" aria-label="Search videos" ${S.ytLoad?'disabled':''}>
            <button id="yt-search" class="cyber-btn" style="background:#ff0000;color:#fff" ${S.ytLoad?'disabled':''}>${S.ytLoad?'<span class="loader"></span>':'SEARCH'}</button>
          </div>
          ${S.ytVid?`<iframe style="width:100%;aspect-ratio:16/9;border-radius:12px;border:none;margin-bottom:15px" src="https://www.youtube.com/embed/${Utils.escape(S.ytVid)}?autoplay=1" allowfullscreen title="YouTube video player"></iframe>`:''}
          <div style="flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px" role="list" aria-label="Search results">
            ${S.ytRes.map(v=>`
              <button class="yt-video cyber-card" data-vid="${Utils.escape(v.id)}" style="overflow:hidden;cursor:pointer;border:none;text-align:left;width:100%" role="listitem" aria-label="Play ${Utils.escape(v.ti)}">
                <img src="${Utils.escape(v.t)}" style="width:100%;aspect-ratio:16/9;object-fit:cover" alt="" loading="lazy">
                <div style="padding:10px"><div style="font-size:11px;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${Utils.escape(v.ti)}</div></div>
              </button>
            `).join('')}
          </div>
        </div>`;
      },
      
      renderBuildApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
          ${hdr('ğŸ”§','Build Console')}
          <button id="build-run" class="cyber-btn" style="background:${S.bldStat==='building'?'#405060':'linear-gradient(135deg,#00ff88,#00aaff)'};color:${S.bldStat==='building'?'#888':'#000'};margin-bottom:15px;width:fit-content" ${S.bldStat==='building'?'disabled':''}>${S.bldStat==='building'?'â³ BUILDING...':'âš¡ START BUILD'}</button>
          <div style="background:rgba(0,0,0,0.4);border-radius:12px;padding:15px;margin-bottom:15px;border:1px solid rgba(0,255,136,0.15)" role="progressbar" aria-valuenow="${S.bldP}" aria-valuemin="0" aria-valuemax="100">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px">
              <span style="font-size:11px;color:#607090;font-family:'Orbitron',sans-serif">PROGRESS</span>
              <span style="font-size:12px;color:#00ff88;font-family:'JetBrains Mono',monospace">${S.bldP}%</span>
            </div>
            <div style="height:6px;background:rgba(0,255,136,0.1);border-radius:3px;overflow:hidden">
              <div style="width:${S.bldP}%;height:100%;background:linear-gradient(90deg,#00ff88,#00f0ff);border-radius:3px;transition:width 0.2s"></div>
            </div>
          </div>
          <div style="flex:1;overflow-y:auto;background:rgba(0,0,0,0.4);border-radius:12px;padding:15px;font-family:'JetBrains Mono',monospace;font-size:11px;border:1px solid rgba(0,240,255,0.1)" role="log" aria-label="Build output">
            ${S.bldLog.map(l=>`<div style="color:${l.startsWith('[')?'#00f0ff':l.includes('âœ“')||l.includes('âœ…')?'#00ff88':'#8090a0'};margin-bottom:6px">${Utils.escape(l)}</div>`).join('')}
          </div>
        </div>`;
      },
      
      renderRadioApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
          ${hdr('ğŸ“»','Radio Browser')}
          <div style="display:flex;gap:10px;margin-bottom:15px">
            <input id="rad-input" placeholder="Search 30,000+ stations..." class="cyber-input" style="flex:1" aria-label="Search radio stations" ${S.radLoad?'disabled':''}>
            <button id="rad-search" class="cyber-btn" style="background:linear-gradient(135deg,#ffcc00,#ff8800);color:#000" ${S.radLoad?'disabled':''}>${S.radLoad?'<span class="loader"></span>':'SEARCH'}</button>
          </div>
          ${S.radSt?`
            <div style="background:linear-gradient(135deg,rgba(255,204,0,0.1),rgba(255,100,0,0.05));border:1px solid rgba(255,204,0,0.3);border-radius:12px;padding:15px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center" role="region" aria-label="Now playing">
              <div><div style="font-size:14px;color:#ffcc00;font-family:'Orbitron',sans-serif">ğŸ“» ${Utils.escape(S.radSt.n)}</div><div style="font-size:11px;color:#607090">${Utils.escape(S.radSt.c)}</div></div>
              <button id="rad-toggle" style="width:50px;height:50px;border-radius:50%;border:none;background:${S.radPlay?'linear-gradient(135deg,#ff0055,#cc0044)':'linear-gradient(135deg,#00ff88,#00cc66)'};color:#fff;font-size:20px;cursor:pointer" aria-label="${S.radPlay?'Pause':'Play'}">${S.radPlay?'â¸':'â–¶'}</button>
            </div>
          `:''}
          <div style="flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px" role="list" aria-label="Radio stations">
            ${S.radRes.map((s,i)=>`
              <button class="rad-station cyber-card" data-idx="${i}" style="padding:12px;cursor:pointer;border:none;text-align:left;width:100%" role="listitem" aria-label="Play ${Utils.escape(s.n)}">
                <div style="font-size:11px;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ğŸ“» ${Utils.escape(s.n)}</div>
                <div style="font-size:9px;color:#505060;margin-top:4px">${Utils.escape(s.c)}</div>
              </button>
            `).join('')}
          </div>
        </div>`;
      },
      
      renderTerminalApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden;background:rgba(0,5,0,0.85)">
          ${hdr('âŒ¨ï¸','Terminal')}
          <div id="term-output" style="flex:1;overflow-y:auto;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6" role="log" aria-label="Terminal output" aria-live="polite">
            ${S.termLn.map(l=>`<div style="color:${l.startsWith('>')?'#00f0ff':l.startsWith('[')?'#00ff88':'#00ff00'};margin-bottom:4px">${Utils.escape(l)}</div>`).join('')}
          </div>
          <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
            <span style="color:#00ff88;font-family:'JetBrains Mono',monospace" aria-hidden="true">$</span>
            <input id="term-input" placeholder="Type command..." style="flex:1;background:transparent;border:none;color:#00ff88;font-family:'JetBrains Mono',monospace;font-size:13px;outline:none" aria-label="Enter command">
          </div>
        </div>`;
      },
      
      renderIDEApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
          ${hdr('ğŸ’»','IDE')}
          <button id="ide-run" class="cyber-btn" style="background:linear-gradient(135deg,#ff00aa,#8b00ff);color:#fff;width:fit-content;margin-bottom:15px">â–¶ RUN CODE</button>
          <div style="flex:1;display:flex;gap:15px;flex-direction:${m?'column':'row'}">
            <div style="flex:1;display:flex;flex-direction:column;min-height:180px">
              <div style="padding:8px 12px;background:rgba(0,240,255,0.1);border-radius:8px 8px 0 0;font-size:10px;color:#607090;font-family:'Orbitron',sans-serif;border:1px solid rgba(0,240,255,0.2);border-bottom:none">ğŸ“ CODE</div>
              <textarea id="ide-code" style="flex:1;background:rgba(0,5,15,0.8);border:1px solid rgba(0,240,255,0.2);border-radius:0 0 8px 8px;padding:12px;color:#00ff88;font-family:'JetBrains Mono',monospace;font-size:12px;resize:none;outline:none" aria-label="Code editor">${Utils.escape(S.ideCode)}</textarea>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;min-height:180px">
              <div style="padding:8px 12px;background:rgba(255,0,170,0.1);border-radius:8px 8px 0 0;font-size:10px;color:#607090;font-family:'Orbitron',sans-serif;border:1px solid rgba(255,0,170,0.2);border-bottom:none">ğŸ–¥ï¸ PREVIEW</div>
              <iframe id="ide-preview" style="flex:1;background:#fff;border-radius:0 0 8px 8px;border:1px solid rgba(255,0,170,0.2)" sandbox="allow-scripts" title="Code preview"></iframe>
            </div>
          </div>
        </div>`;
      },
      
      renderArtApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
          ${hdr('ğŸ¨','Art Studio')}
          <textarea id="art-input" placeholder="Describe your image... (e.g., 'cyberpunk city with neon lights')" class="cyber-input" style="height:80px;resize:none;margin-bottom:10px" aria-label="Image description" ${S.artLoad?'disabled':''}></textarea>
          <button id="art-gen" class="cyber-btn" style="background:${S.artLoad?'#405060':'linear-gradient(135deg,#ff00aa,#8b00ff)'};color:${S.artLoad?'#888':'#fff'};margin-bottom:15px;width:fit-content" ${S.artLoad?'disabled':''}>${S.artLoad?'<span class="loader"></span> GENERATING...':'ğŸ¨ GENERATE IMAGE'}</button>
          <div style="flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;align-content:start" role="list" aria-label="Generated images">
            ${S.artImgs.map((img,i)=>`<button class="art-img cyber-card" data-idx="${i}" style="padding:0;border:2px solid rgba(255,0,170,0.3)" role="listitem" aria-label="View generated image"><img src="${Utils.escape(img.u)}" style="aspect-ratio:1;border-radius:14px;object-fit:cover;width:100%" alt="Generated image" loading="lazy"></button>`).join('')}
          </div>
        </div>`;
      },
      
      renderGamesApp(hdr, m) {
        const S = this.state;
        
        // Game menu
        if (!S.gameType) {
          return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
            ${hdr('ğŸ®','Games Center')}
            <div style="flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:15px;align-content:start;padding:10px" role="list" aria-label="Available games">
              <button class="game-select cyber-card" data-game="snake" style="padding:25px;text-align:center;cursor:pointer;border:none" role="listitem" aria-label="Play Snake game">
                <div style="font-size:48px;margin-bottom:10px" aria-hidden="true">ğŸ</div>
                <div style="font-family:'Orbitron',sans-serif;font-size:12px;color:#00ff88">SNAKE</div>
                <div style="font-size:10px;color:#505060;margin-top:5px">Classic arcade</div>
              </button>
              <button class="game-select cyber-card" data-game="memory" style="padding:25px;text-align:center;cursor:pointer;border:none" role="listitem" aria-label="Play Memory game">
                <div style="font-size:48px;margin-bottom:10px" aria-hidden="true">ğŸ§ </div>
                <div style="font-family:'Orbitron',sans-serif;font-size:12px;color:#ff00aa">MEMORY</div>
                <div style="font-size:10px;color:#505060;margin-top:5px">Match pairs</div>
              </button>
              <button class="game-select cyber-card" data-game="reaction" style="padding:25px;text-align:center;cursor:pointer;border:none" role="listitem" aria-label="Play Reaction game">
                <div style="font-size:48px;margin-bottom:10px" aria-hidden="true">âš¡</div>
                <div style="font-family:'Orbitron',sans-serif;font-size:12px;color:#ffcc00">REACTION</div>
                <div style="font-size:10px;color:#505060;margin-top:5px">Test reflexes</div>
              </button>
            </div>
            <div style="padding:15px;background:rgba(0,0,0,0.3);border-radius:12px;margin-top:10px">
              <div style="font-size:11px;color:#607090;text-align:center">ğŸ® Select a game to play â€¢ Use arrow keys or swipe for mobile</div>
            </div>
          </div>`;
        }
        
        // Snake Game
        if (S.gameType === 'snake') {
          const grid = this.renderSnakeGrid();
          return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px">
              <button class="back-btn game-back" aria-label="Back to games">â† Back</button>
              <span style="font-size:24px" aria-hidden="true">ğŸ</span>
              <span style="font-family:'Orbitron',sans-serif;font-size:14px;color:#fff">SNAKE</span>
              <span style="margin-left:auto;font-family:'Orbitron',sans-serif;color:#00ff88" aria-live="polite">SCORE: ${S.snake.score}</span>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center">
              <div id="snake-grid" style="display:grid;grid-template-columns:repeat(15,20px);grid-template-rows:repeat(15,20px);gap:1px;background:rgba(0,20,0,0.8);padding:10px;border-radius:12px;border:2px solid rgba(0,255,136,0.3)" role="application" aria-label="Snake game board">
                ${grid}
              </div>
              ${S.snake.over?'<div style="margin-top:20px;font-family:Orbitron,sans-serif;font-size:24px;color:#ff0055" role="alert">GAME OVER</div><button id="snake-restart" class="cyber-btn" style="margin-top:15px;background:linear-gradient(135deg,#00ff88,#00f0ff);color:#000">PLAY AGAIN</button>':''}
              ${!S.snake.over&&S.snake.body.length===1?'<div style="margin-top:15px;font-size:12px;color:#607090">Use arrow keys, WASD, or swipe to move</div>':''}
            </div>
            <div style="display:flex;justify-content:center;gap:10px;margin-top:15px">
              <button class="snake-dir cyber-btn" data-dir="up" style="padding:15px 20px;background:rgba(0,255,136,0.2);color:#00ff88" aria-label="Move up">â†‘</button>
            </div>
            <div style="display:flex;justify-content:center;gap:10px">
              <button class="snake-dir cyber-btn" data-dir="left" style="padding:15px 20px;background:rgba(0,255,136,0.2);color:#00ff88" aria-label="Move left">â†</button>
              <button class="snake-dir cyber-btn" data-dir="down" style="padding:15px 20px;background:rgba(0,255,136,0.2);color:#00ff88" aria-label="Move down">â†“</button>
              <button class="snake-dir cyber-btn" data-dir="right" style="padding:15px 20px;background:rgba(0,255,136,0.2);color:#00ff88" aria-label="Move right">â†’</button>
            </div>
          </div>`;
        }
        
        // Memory Game
        if (S.gameType === 'memory') {
          const cards = this.renderMemoryCards();
          return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px">
              <button class="back-btn game-back" aria-label="Back to games">â† Back</button>
              <span style="font-size:24px" aria-hidden="true">ğŸ§ </span>
              <span style="font-family:'Orbitron',sans-serif;font-size:14px;color:#fff">MEMORY</span>
              <span style="margin-left:auto;font-family:'Orbitron',sans-serif;color:#ff00aa" aria-live="polite">MOVES: ${S.memory.moves}</span>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow-y:auto">
              <div id="memory-grid" style="display:grid;grid-template-columns:repeat(4,70px);grid-template-rows:repeat(4,70px);gap:8px" role="application" aria-label="Memory game board">
                ${cards}
              </div>
              ${S.memory.done?'<div style="margin-top:20px;font-family:Orbitron,sans-serif;font-size:20px;color:#00ff88" role="alert">ğŸ‰ YOU WIN!</div><button id="memory-restart" class="cyber-btn" style="margin-top:15px;background:linear-gradient(135deg,#ff00aa,#8b00ff);color:#fff">PLAY AGAIN</button>':''}
            </div>
          </div>`;
        }
        
        // Reaction Game
        if (S.gameType === 'reaction') {
          const r = S.reaction;
          const bgColor = r.state === 'wait' ? 'rgba(255,0,85,0.2)' : 
                          r.state === 'ready' ? 'rgba(0,255,136,0.2)' : 
                          r.state === 'click' ? 'rgba(255,204,0,0.3)' : 'rgba(0,240,255,0.2)';
          const bgBorder = r.state === 'wait' ? 'rgba(255,0,85,0.5)' : 
                           r.state === 'ready' ? 'rgba(0,255,136,0.5)' : 
                           r.state === 'click' ? 'rgba(255,204,0,0.5)' : 'rgba(0,240,255,0.5)';
          return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px">
              <button class="back-btn game-back" aria-label="Back to games">â† Back</button>
              <span style="font-size:24px" aria-hidden="true">âš¡</span>
              <span style="font-family:'Orbitron',sans-serif;font-size:14px;color:#fff">REACTION</span>
              ${r.score>0?`<span style="margin-left:auto;font-family:'Orbitron',sans-serif;color:#ffcc00" aria-live="polite">BEST: ${r.score}ms</span>`:''}
            </div>
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center">
              <button id="reaction-box" style="width:280px;height:280px;border-radius:20px;background:${bgColor};border:3px solid ${bgBorder};display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s" aria-label="Reaction test area - ${r.state === 'wait' ? 'Click to start' : r.state === 'ready' ? 'Wait for green' : r.state === 'click' ? 'Click now!' : 'View result'}">
                ${r.state === 'wait' ? '<div style="font-size:48px" aria-hidden="true">ğŸ”´</div><div style="font-family:Orbitron,sans-serif;font-size:14px;color:#ff0055;margin-top:15px">Click to Start</div>' : ''}
                ${r.state === 'ready' ? '<div style="font-size:48px" aria-hidden="true">ğŸŸ¡</div><div style="font-family:Orbitron,sans-serif;font-size:14px;color:#ffcc00;margin-top:15px">Wait for green...</div>' : ''}
                ${r.state === 'click' ? '<div style="font-size:48px" aria-hidden="true">ğŸŸ¢</div><div style="font-family:Orbitron,sans-serif;font-size:14px;color:#00ff88;margin-top:15px">CLICK NOW!</div>' : ''}
                ${r.state === 'result' ? '<div style="font-size:48px" aria-hidden="true">âš¡</div><div style="font-family:Orbitron,sans-serif;font-size:28px;color:#00f0ff;margin-top:15px">' + r.score + 'ms</div><div style="font-size:12px;color:#607090;margin-top:10px">Click to try again</div>' : ''}
              </button>
              <div style="margin-top:20px;font-size:11px;color:#505060;text-align:center">
                Test your reaction speed!<br>Click when the circle turns green.
              </div>
            </div>
          </div>`;
        }
        
        return '<div style="text-align:center;padding:50px;color:#405060">Select a game</div>';
      },
      
      renderSnakeGrid() {
        const S = this.state.snake;
        let cells = '';
        for (let y = 0; y < 15; y++) {
          for (let x = 0; x < 15; x++) {
            const isHead = S.body[0][0] === x && S.body[0][1] === y;
            const isBody = S.body.slice(1).some(b => b[0] === x && b[1] === y);
            const isFood = S.food[0] === x && S.food[1] === y;
            const bg = isHead ? '#00ff88' : isBody ? '#00cc66' : isFood ? '#ff0055' : 'rgba(0,50,0,0.5)';
            const radius = isHead ? '50%' : isFood ? '50%' : '3px';
            cells += `<div style="width:20px;height:20px;background:${bg};border-radius:${radius};transition:background 0.1s" aria-hidden="true"></div>`;
          }
        }
        return cells;
      },
      
      renderMemoryCards() {
        const S = this.state.memory;
        const emojis = ['ğŸ®', 'ğŸ¯', 'ğŸ²', 'ğŸ°', 'ğŸª', 'ğŸ¨', 'ğŸ­', 'ğŸª'];
        let cards = '';
        for (let i = 0; i < 16; i++) {
          const isFlipped = S.flipped.includes(i) || S.matched.includes(i);
          const isMatched = S.matched.includes(i);
          const emoji = isFlipped ? emojis[S.cards[i] % 8] : '?';
          const bg = isMatched ? 'rgba(0,255,136,0.3)' : isFlipped ? 'rgba(139,0,255,0.3)' : 'rgba(0,240,255,0.1)';
          const border = isMatched ? 'rgba(0,255,136,0.5)' : isFlipped ? 'rgba(139,0,255,0.5)' : 'rgba(0,240,255,0.2)';
          cards += `<button class="memory-card" data-idx="${i}" style="width:70px;height:70px;background:${bg};border:2px solid ${border};border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:${isMatched?'default':'pointer'};transition:all 0.2s" ${isMatched?'disabled':''} aria-label="Card ${i+1}, ${isFlipped ? emoji : 'hidden'}">${emoji}</button>`;
        }
        return cards;
      },
      
      renderToolsApp(hdr, m) {
        const S = this.state;
        const tools = [{n:'Node.js',i:'ğŸŸ¢',v:'20.10'},{n:'Python',i:'ğŸ',v:'3.12'},{n:'Java',i:'â˜•',v:'21.0'},{n:'Rust',i:'ğŸ¦€',v:'1.75'},{n:'Go',i:'ğŸ¹',v:'1.21'},{n:'Docker',i:'ğŸ³',v:'24.0'}];
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;overflow-y:auto">
          ${hdr('ğŸ› ï¸','System Tools')}
          ${S.toolInst?`<div style="background:rgba(0,0,0,0.4);border-radius:12px;padding:15px;margin-bottom:15px;border:1px solid rgba(136,85,255,0.2)" role="status" aria-live="polite"><div style="margin-bottom:10px;color:#fff">Installing ${Utils.escape(S.toolInst)}...</div><div style="height:6px;background:rgba(136,85,255,0.1);border-radius:3px;overflow:hidden"><div style="width:${S.toolProg}%;height:100%;background:linear-gradient(90deg,#8855ff,#00f0ff);transition:width 0.2s"></div></div></div>`:''}
          <div style="display:grid;gap:10px" role="list">${tools.map(t=>`
            <div class="cyber-card" style="padding:15px;display:flex;align-items:center;justify-content:space-between" role="listitem">
              <div style="display:flex;align-items:center;gap:15px"><span style="font-size:28px" aria-hidden="true">${t.i}</span><div><div style="color:#fff;font-size:14px">${Utils.escape(t.n)}</div><div style="font-size:10px;color:#405060">v${t.v}</div></div></div>
              <button class="tool-install cyber-btn" data-tool="${t.n}" style="background:linear-gradient(135deg,#8855ff,#00f0ff);color:#fff;padding:8px 16px;font-size:10px" ${S.toolInst?'disabled':''}>INSTALL</button>
            </div>
          `).join('')}</div>
        </div>`;
      },
      
      renderAdminApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;display:flex;flex-direction:column;overflow:hidden">
          ${hdr('ğŸ‘‘','Admin Panel')}
          <button id="adm-refresh" class="cyber-btn" style="background:linear-gradient(135deg,#ff00aa,#8b00ff);color:#fff;width:fit-content;margin-bottom:15px" ${S.admLoad?'disabled':''}>${S.admLoad?'<span class="loader"></span>':'ğŸ”„'} REFRESH</button>
          ${S.admStat?`
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px" role="region" aria-label="Statistics">
              <div style="background:rgba(0,240,255,0.1);border-radius:10px;padding:15px;text-align:center;border:1px solid rgba(0,240,255,0.2)"><div style="font-size:22px;color:#00f0ff;font-family:'Orbitron',sans-serif">${S.admStat.t||0}</div><div style="font-size:9px;color:#607090">USERS</div></div>
              <div style="background:rgba(0,255,136,0.1);border-radius:10px;padding:15px;text-align:center;border:1px solid rgba(0,255,136,0.2)"><div style="font-size:22px;color:#00ff88;font-family:'Orbitron',sans-serif">${S.admStat.o||0}</div><div style="font-size:9px;color:#607090">ONLINE</div></div>
              <div style="background:rgba(255,204,0,0.1);border-radius:10px;padding:15px;text-align:center;border:1px solid rgba(255,204,0,0.2)"><div style="font-size:22px;color:#ffcc00;font-family:'Orbitron',sans-serif">${S.admStat.p||0}</div><div style="font-size:9px;color:#607090">PREMIUM</div></div>
              <div style="background:rgba(255,0,85,0.1);border-radius:10px;padding:15px;text-align:center;border:1px solid rgba(255,0,85,0.2)"><div style="font-size:22px;color:#ff0055;font-family:'Orbitron',sans-serif">${S.admStat.b||0}</div><div style="font-size:9px;color:#607090">BANNED</div></div>
            </div>
          `:''}
          <div style="flex:1;overflow-y:auto" role="list" aria-label="User list">
            ${(S.admUsr||[]).map(u=>`
              <div class="cyber-card" style="padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center" role="listitem">
                <div><div style="color:#fff;font-size:13px">${Utils.escape(u.displayName||u.username)}</div><div style="font-size:10px;color:#405060">${Utils.escape(u.email||'')} â€¢ ${Utils.escape(u.role)}</div></div>
                <div style="display:flex;gap:6px">
                  ${u.role!=='admin'?`<button class="adm-action cyber-btn" data-uid="${u.id}" data-action="setRole" data-role="admin" style="padding:5px 10px;background:rgba(255,0,170,0.2);color:#ff00aa;font-size:9px" aria-label="Make admin">ğŸ‘‘</button>`:''}
                  <button class="adm-action cyber-btn" data-uid="${u.id}" data-action="${u.isBanned?'unban':'ban'}" style="padding:5px 10px;background:rgba(${u.isBanned?'0,255,136':'255,0,85'},0.2);color:${u.isBanned?'#00ff88':'#ff0055'};font-size:9px" aria-label="${u.isBanned?'Unban':'Ban'} user">${u.isBanned?'UNBAN':'BAN'}</button>
                  ${!u.isPremium?`<button class="adm-action cyber-btn" data-uid="${u.id}" data-action="grantPremium" style="padding:5px 10px;background:rgba(255,204,0,0.2);color:#ffcc00;font-size:9px" aria-label="Grant premium">â­</button>`:''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
      },
      
      renderSettingsApp(hdr, m) {
        const S = this.state;
        return `<div class="cyber-card neon-border" style="height:calc(100vh - 160px);padding:15px;overflow-y:auto">
          ${hdr('âš™ï¸','Settings')}
          <div style="background:rgba(0,0,0,0.4);border-radius:12px;padding:20px;margin-bottom:15px;border:1px solid rgba(0,240,255,0.1)">
            <div style="font-family:'Orbitron',sans-serif;font-size:11px;color:#00f0ff;margin-bottom:15px;letter-spacing:2px">SYSTEM INFO</div>
            <div style="font-size:13px;color:#8090a0;line-height:2">
              <div>Version: <span style="color:#00f0ff">V14.2 Cyberpunk</span></div>
              <div>User: <span style="color:#fff">${Utils.escape(S.user?.displayName||'Guest')}</span></div>
              <div>Role: <span style="color:${S.user?.role==='admin'?'#ff00aa':'#00f0ff'}">${Utils.escape(S.user?.role||'guest')}</span></div>
              <div>Network: <span style="color:${S.online?'#00ff88':'#ff0055'}">${S.online?'Online':'Offline'}</span></div>
            </div>
          </div>
          <div style="background:rgba(0,0,0,0.4);border-radius:12px;padding:20px;border:1px solid rgba(139,0,255,0.1)">
            <div style="font-family:'Orbitron',sans-serif;font-size:11px;color:#8b00ff;margin-bottom:15px;letter-spacing:2px">FEATURES</div>
            <div style="font-size:13px;color:#8090a0;line-height:2">
              <div>ğŸ¤– Smart AI Assistant</div>
              <div>ğŸ’¡ Context-Aware Copilot</div>
              <div>ğŸ”§ Real-time Build Console</div>
              <div>ğŸ“» 30,000+ Radio Stations</div>
              <div>ğŸ’» IDE with Live Preview</div>
              <div>ğŸ¨ AI Image Generation</div>
              <div>ğŸ® Arcade Games</div>
            </div>
          </div>
          <div style="margin-top:15px">
            <button id="clear-storage" class="cyber-btn" style="background:rgba(255,0,85,0.2);color:#ff0055;border:1px solid rgba(255,0,85,0.3)">ğŸ—‘ï¸ Clear Local Data</button>
          </div>
        </div>`;
      },
      
      renderCopilot() {
        const S = this.state;
        return `<div class="glass" style="width:320px;border-left:1px solid rgba(139,0,255,0.3);display:flex;flex-direction:column" role="complementary" aria-label="AI Copilot">
          <div style="padding:12px;background:linear-gradient(135deg,rgba(139,0,255,0.1),rgba(255,0,170,0.1));border-bottom:1px solid rgba(139,0,255,0.2);display:flex;justify-content:space-between;align-items:center">
            <span style="font-family:'Orbitron',sans-serif;font-size:10px;color:#ff00aa;letter-spacing:2px">ğŸ’¡ AI COPILOT</span>
            <button id="cop-close" style="width:24px;height:24px;background:rgba(255,0,85,0.2);border:none;border-radius:6px;color:#ff0055;cursor:pointer;font-size:12px" aria-label="Close copilot">âœ•</button>
          </div>
          <div id="cop-messages" style="flex:1;overflow-y:auto;padding:12px" role="log" aria-live="polite" aria-label="Copilot messages">
            ${S.copMsgs.length===0?'<div style="text-align:center;padding:20px;color:#405060;font-size:12px">Ask me anything!</div>':''}
            ${S.copMsgs.map(msg=>`
              <div style="margin-bottom:12px" role="article">
                <div style="font-size:9px;color:${msg.r==='user'?'#00f0ff':'#ff00aa'};margin-bottom:6px;font-family:'Orbitron',sans-serif">${msg.r==='user'?'ğŸ‘¤ YOU':'ğŸ’¡ COPILOT'}</div>
                <div style="background:rgba(${msg.r==='user'?'0,240,255':'139,0,255'},0.1);border-radius:10px;padding:10px 14px;font-size:12px;white-space:pre-wrap;border:1px solid rgba(${msg.r==='user'?'0,240,255':'139,0,255'},0.15)">${Utils.escape(msg.c)}</div>
              </div>
            `).join('')}
            ${S.copLoad?'<div style="text-align:center;color:#607090;padding:10px"><span class="pulse">ğŸ’¡</span> Thinking...</div>':''}
          </div>
          <div style="padding:12px;border-top:1px solid rgba(139,0,255,0.2)">
            <div style="display:flex;gap:8px">
              <input id="cop-input" placeholder="Ask..." class="cyber-input" style="flex:1;padding:10px 14px;font-size:12px" aria-label="Ask copilot" ${S.copLoad?'disabled':''}>
              <button id="cop-send" class="glow cyber-btn" style="padding:10px 14px;background:linear-gradient(135deg,#ff00aa,#8b00ff);color:#fff" ${S.copLoad?'disabled':''}>ğŸ’¡</button>
            </div>
          </div>
        </div>`;
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CORE FUNCTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      async askAI(msgs, sys) {
        try {
          if (window.puter?.ai?.chat) {
            const res = await window.puter.ai.chat(
              [{ role: 'system', content: sys || 'You are NEXUS AI. Be helpful and concise.' }, ...msgs],
              { model: 'gpt-4o-mini' }
            );
            return typeof res === 'string' ? res : res.message?.content || 'Done.';
          }
          return 'AI loading... Please wait and try again.';
        } catch (e) {
          console.error('[AI] Error:', e);
          return 'AI temporarily unavailable. Please try again.';
        }
      },
      
      async login(username, password) {
        const user = await AuthManager.validate(username, password);
        if (user) {
          this.state.user = user;
          this.state.phase = 'desktop';
          this.state.aiMsgs = [{ r: 'assistant', c: `ğŸ‘‹ Welcome, ${user.displayName}!` }];
          Storage.save(this.state);
          this.notify(`Welcome, ${user.displayName}!`);
          this.render();
          return true;
        }
        this.notify('âš ï¸ Invalid credentials');
        return false;
      },
      
      guestLogin() {
        this.state.user = AuthManager.createGuestUser();
        this.state.phase = 'desktop';
        this.notify('ğŸ‘‹ Welcome!');
        this.render();
      },
      
      logout() {
        Storage.clear();
        AudioManager.cleanup();
        GameManager.cleanup();
        this.state.user = null;
        this.state.phase = 'login';
        this.state.app = null;
        this.state.copOpen = false;
        this.render();
      },
      
      openApp(id) {
        // Cleanup previous app resources
        this.cleanupAppResources();
        
        this.state.app = id;
        if (id === 'adm') this.loadAdmin();
        this.render();
      },
      
      closeApp() {
        this.cleanupAppResources();
        this.state.app = null;
        this.state.copOpen = false;
        this.render();
      },
      
      cleanupAppResources() {
        // Stop audio when leaving radio
        if (this.state.app === 'rad') {
          AudioManager.stop();
          this.state.radPlay = false;
        }
        // Clear game intervals
        if (this.state.gameType) {
          GameManager.cleanup();
          this.state.gameType = null;
        }
      },
      
      toggleCopilot() {
        this.state.copOpen = !this.state.copOpen;
        if (this.state.copOpen && this.state.copMsgs.length === 0) {
          this.state.copMsgs = [{ r: 'assistant', c: 'ğŸ’¡ Hi! I\'m your NEXUS Copilot.\n\nI can help with:\nâ€¢ Code & debugging\nâ€¢ Terminal commands\nâ€¢ Build & deploy\n\nWhat do you need?' }];
        }
        this.render();
      },
      
      // AI Chat
      async sendAIMessage() {
        const input = document.getElementById('ai-input');
        const msg = Utils.sanitize(input?.value);
        if (!msg || this.state.aiLoad) return;
        
        this.state.aiMsgs.push({ r: 'user', c: msg });
        input.value = '';
        this.state.aiLoad = true;
        this.render();
        
        const resp = await this.askAI(this.state.aiMsgs.slice(-10));
        this.state.aiMsgs.push({ r: 'assistant', c: resp });
        this.state.aiLoad = false;
        Storage.save(this.state);
        this.render();
      },
      
      // Copilot
      async sendCopilotMessage() {
        const input = document.getElementById('cop-input');
        const msg = Utils.sanitize(input?.value);
        if (!msg || this.state.copLoad) return;
        
        input.value = '';
        this.state.copMsgs.push({ r: 'user', c: msg });
        this.state.copLoad = true;
        this.render();
        
        const ctx = this.state.app ? `User is in ${this.state.app} app.` : 'User is on desktop.';
        const resp = await this.askAI(this.state.copMsgs.slice(-6), `You are NEXUS Copilot. ${ctx}`);
        this.state.copMsgs.push({ r: 'assistant', c: resp });
        this.state.copLoad = false;
        this.render();
      },
      
      // YouTube
      async searchYouTube() {
        const input = document.getElementById('yt-input');
        const q = Utils.sanitize(input?.value);
        if (!q || this.state.ytLoad) return;
        
        this.state.ytLoad = true;
        this.render();
        
        try {
          const res = await fetch(`https://inv.nadeko.net/api/v1/search?q=${encodeURIComponent(q)}&type=video`);
          if (!res.ok) throw new Error('Search failed');
          const data = await res.json();
          this.state.ytRes = (data || []).slice(0, 8).map(v => ({
            id: v.videoId,
            ti: v.title,
            t: `https://img.youtube.com/vi/${v.videoId}/mqdefault.jpg`
          }));
        } catch (e) {
          console.error('[YouTube] Error:', e);
          this.state.ytRes = [];
          this.notify('âš ï¸ Search failed');
        }
        this.state.ytLoad = false;
        this.render();
      },
      
      playYouTube(id) {
        this.state.ytVid = id;
        this.render();
      },
      
      // Build
      runBuild() {
        if (this.state.bldStat === 'building') return;
        
        this.state.bldStat = 'building';
        this.state.bldP = 0;
        this.state.bldLog = ['[BUILD] Starting...'];
        this.render();
        
        const steps = [
          {p:15, l:'[BUILD] Resolving dependencies...'},
          {p:30, l:'[BUILD] Installing packages...'},
          {p:45, l:'âœ“ Packages ready'},
          {p:60, l:'[BUILD] Compiling source...'},
          {p:75, l:'[BUILD] Optimizing assets...'},
          {p:90, l:'[BUILD] Generating build...'},
          {p:100, l:'âœ… Build complete!'}
        ];
        
        let i = 0;
        const run = () => {
          if (i < steps.length) {
            this.state.bldP = steps[i].p;
            this.state.bldLog.push(steps[i].l);
            i++;
            this.render();
            setTimeout(run, 300);
          } else {
            this.state.bldStat = 'success';
            this.notify('âœ… Build successful!');
            this.render();
          }
        };
        run();
      },
      
      // Radio
      async searchRadio() {
        const input = document.getElementById('rad-input');
        const q = Utils.sanitize(input?.value);
        if (!q || this.state.radLoad) return;
        
        this.state.radLoad = true;
        this.render();
        
        try {
          const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?name=${encodeURIComponent(q)}&limit=12`, {
            headers: { 'User-Agent': 'NEXUS-OS-V14.2' }
          });
          if (!res.ok) throw new Error('Search failed');
          const data = await res.json();
          this.state.radRes = (data || []).map(s => ({
            n: s.name,
            u: s.url_resolved || s.url,
            c: s.country || 'Unknown'
          })).filter(s => s.u);
        } catch (e) {
          console.error('[Radio] Error:', e);
          this.state.radRes = [];
          this.notify('âš ï¸ Search failed');
        }
        this.state.radLoad = false;
        this.render();
      },
      
      async playRadio(idx) {
        const st = this.state.radRes[idx];
        if (!st) return;
        
        const success = await AudioManager.play(st.u);
        if (success) {
          this.state.radSt = st;
          this.state.radPlay = true;
        } else {
          this.state.radPlay = false;
          this.notify('âš ï¸ Cannot play this station');
        }
        this.render();
      },
      
      toggleRadio() {
        AudioManager.toggle();
        this.state.radPlay = AudioManager.isPlaying;
        this.render();
      },
      
      // Terminal
      runTerminalCommand(cmd) {
        const cmds = {
          help: () => ['Commands: help, clear, date, whoami, build, neofetch, version'],
          clear: () => { this.state.termLn = []; return []; },
          date: () => [new Date().toString()],
          whoami: () => [this.state.user?.username || 'guest'],
          build: () => { this.openApp('bld'); this.runBuild(); return ['[SYSTEM] Starting build...']; },
          version: () => ['NEXUS OS V14.2 Cyberpunk'],
          neofetch: () => [
            'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—',
            'â•‘   NEXUS OS V14.2   â•‘',
            'â•‘   CYBERPUNK ED.    â•‘',
            'â•‘   Improved Ver.    â•‘',
            'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
          ]
        };
        
        const cmdLower = cmd?.toLowerCase().trim() || '';
        const out = cmds[cmdLower]?.() || [`[ERROR] Unknown command: ${cmd}`, 'Type "help" for available commands.'];
        this.state.termLn.push(`> ${cmd}`, ...out, '');
        this.render();
      },
      
      // IDE
      runIDE() {
        const code = document.getElementById('ide-code')?.value || this.state.ideCode;
        this.state.ideCode = code;
        Storage.save(this.state);
        
        const iframe = document.getElementById('ide-preview');
        if (iframe) {
          // Use sandboxed iframe for security
          iframe.srcdoc = `<!DOCTYPE html><html><head><style>*{margin:0;padding:0;font-family:system-ui}body{background:#0a0a1a;color:#00f0ff;padding:20px}</style></head><body><script>try{${code}}catch(e){document.body.innerHTML='<div style="color:#ff0055;padding:20px;font-family:monospace">Error: '+e.message+'<\\/div>'}<\/script></body></html>`;
        }
        this.notify('â–¶ï¸ Code executed!');
      },
      
      // Art
      async generateArt() {
        const input = document.getElementById('art-input');
        const prompt = Utils.sanitize(input?.value);
        if (!prompt || this.state.artLoad) return;
        
        this.state.artLoad = true;
        this.render();
        
        try {
          if (window.puter?.ai?.txt2img) {
            const res = await window.puter.ai.txt2img(prompt + ', digital art, cyberpunk style');
            const url = typeof res === 'string' ? res : res.url || res.image;
            if (url) {
              this.state.artImgs.unshift({ u: url, prompt });
              this.notify('ğŸ¨ Image created!');
            }
          } else {
            this.notify('âš ï¸ AI not loaded yet. Please wait.');
          }
        } catch (e) {
          console.error('[Art] Error:', e);
          this.notify('âš ï¸ Generation failed');
        }
        this.state.artLoad = false;
        this.render();
      },
      
      // Tools
      installTool(name) {
        this.state.toolInst = name;
        this.state.toolProg = 0;
        this.render();
        
        let p = 0;
        const run = () => {
          if (p <= 100) {
            this.state.toolProg = p;
            p += 20;
            this.render();
            setTimeout(run, 200);
          } else {
            this.state.toolInst = null;
            this.notify(`âœ… ${name} installed!`);
            this.render();
          }
        };
        run();
      },
      
      // Admin
      async loadAdmin() {
        this.state.admLoad = true;
        this.render();
        
        try {
          const res = await fetch('/api/users');
          if (!res.ok) throw new Error('Failed to load');
          const data = await res.json();
          this.state.admUsr = data.users || [];
          this.state.admStat = {
            t: data.stats?.total || 0,
            o: data.stats?.online || 0,
            p: data.stats?.premium || 0,
            b: data.stats?.banned || 0
          };
        } catch (e) {
          console.error('[Admin] Error:', e);
          this.state.admUsr = [];
          this.state.admStat = null;
          this.notify('âš ï¸ Failed to load admin data');
        }
        this.state.admLoad = false;
        this.render();
      },
      
      async adminAction(userId, action, extraData = {}) {
        try {
          const res = await fetch('/api/users', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, action, ...extraData })
          });
          if (!res.ok) throw new Error('Action failed');
          this.notify('âœ… Action completed');
          this.loadAdmin();
        } catch (e) {
          console.error('[Admin] Action error:', e);
          this.notify('âš ï¸ Action failed');
        }
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // GAMES
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      selectGame(type) {
        this.state.gameType = type;
        if (type === 'snake') this.startSnake();
        else if (type === 'memory') this.startMemory();
        else if (type === 'reaction') this.startReaction();
        this.render();
      },
      
      exitGame() {
        GameManager.cleanup();
        this.state.gameType = null;
        this.render();
      },
      
      // Snake Game
      startSnake() {
        GameManager.cleanup();
        this.state.snake = {
          body: [[7,7]],
          dir: [1,0],
          food: this.randomFood([[7,7]]),
          score: 0,
          over: false,
          speed: 150
        };
        GameManager.setInterval('snake', () => this.moveSnake(), this.state.snake.speed);
      },
      
      randomFood(body) {
        let pos;
        let attempts = 0;
        do {
          pos = [Math.floor(Math.random() * 15), Math.floor(Math.random() * 15)];
          attempts++;
        } while (body.some(b => b[0] === pos[0] && b[1] === pos[1]) && attempts < 100);
        return pos;
      },
      
      moveSnake() {
        if (this.state.gameType !== 'snake' || this.state.snake.over) return;
        
        const S = this.state.snake;
        const head = [S.body[0][0] + S.dir[0], S.body[0][1] + S.dir[1]];
        
        // Wall collision
        if (head[0] < 0 || head[0] >= 15 || head[1] < 0 || head[1] >= 15) {
          S.over = true;
          GameManager.clearInterval('snake');
          this.render();
          return;
        }
        
        // Self collision
        if (S.body.some(b => b[0] === head[0] && b[1] === head[1])) {
          S.over = true;
          GameManager.clearInterval('snake');
          this.render();
          return;
        }
        
        const newBody = [head, ...S.body];
        
        // Food collision
        if (head[0] === S.food[0] && head[1] === S.food[1]) {
          S.score += 10;
          S.food = this.randomFood(newBody);
        } else {
          newBody.pop();
        }
        
        S.body = newBody;
        this.render();
      },
      
      changeSnakeDirection(dir) {
        const S = this.state.snake;
        if (S.over) return;
        
        const dirs = { up: [0,-1], down: [0,1], left: [-1,0], right: [1,0] };
        const newDir = dirs[dir];
        // Prevent 180 degree turns
        if (newDir && !(newDir[0] === -S.dir[0] && newDir[1] === -S.dir[1])) {
          S.dir = newDir;
        }
      },
      
      // Memory Game
      startMemory() {
        GameManager.cleanup();
        const cards = [];
        for (let i = 0; i < 8; i++) { cards.push(i, i); }
        // Fisher-Yates shuffle
        for (let i = cards.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [cards[i], cards[j]] = [cards[j], cards[i]];
        }
        this.state.memory = { cards, flipped: [], matched: [], moves: 0, done: false };
      },
      
      flipMemoryCard(idx) {
        const M = this.state.memory;
        if (M.done || M.flipped.includes(idx) || M.matched.includes(idx) || M.flipped.length >= 2) return;
        
        M.flipped.push(idx);
        M.moves++;
        this.render();
        
        if (M.flipped.length === 2) {
          const [a, b] = M.flipped;
          if (M.cards[a] === M.cards[b]) {
            M.matched.push(a, b);
            M.flipped = [];
            if (M.matched.length === 16) {
              M.done = true;
            }
            this.render();
          } else {
            GameManager.setTimeout('memory', () => {
              M.flipped = [];
              this.render();
            }, 800);
          }
        }
      },
      
      // Reaction Game
      startReaction() {
        GameManager.cleanup();
        this.state.reaction = { state: 'wait', startTime: 0, score: 0, targetTime: 0 };
      },
      
      handleReactionClick() {
        const R = this.state.reaction;
        
        if (R.state === 'wait') {
          R.state = 'ready';
          this.render();
          // Random delay between 1.5-4.5 seconds
          const delay = 1500 + Math.random() * 3000;
          R.targetTime = Date.now() + delay;
          
          GameManager.setTimeout('reaction', () => {
            if (this.state.reaction.state === 'ready') {
              this.state.reaction.state = 'click';
              this.state.reaction.startTime = Date.now();
              this.render();
            }
          }, delay);
        } else if (R.state === 'ready') {
          // Clicked too early!
          GameManager.clearTimeout('reaction');
          R.state = 'wait';
          this.notify('âš ï¸ Too early! Try again.');
          this.render();
        } else if (R.state === 'click') {
          const reactionTime = Date.now() - R.startTime;
          R.score = reactionTime;
          R.state = 'result';
          this.render();
        } else if (R.state === 'result') {
          R.state = 'wait';
          this.render();
        }
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // EVENT HANDLING
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      setupEvents() {
        // Touch handling for mobile swipe (Snake game)
        let touchStartX = 0;
        let touchStartY = 0;
        
        document.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
          if (this.state.gameType !== 'snake' || this.state.snake.over) return;
          
          const dx = e.changedTouches[0].clientX - touchStartX;
          const dy = e.changedTouches[0].clientY - touchStartY;
          const minSwipe = 30;
          
          if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > minSwipe) {
            this.changeSnakeDirection(dx > 0 ? 'right' : 'left');
          } else if (Math.abs(dy) > minSwipe) {
            this.changeSnakeDirection(dy > 0 ? 'down' : 'up');
          }
        }, { passive: true });
        
        // Click delegation
        document.addEventListener('click', (e) => {
          const target = e.target;
          
          // Login form
          if (target.id === 'guest-btn') {
            this.guestLogin();
            return;
          }
          
          // Logout
          if (target.id === 'logout-btn') {
            this.logout();
            return;
          }
          
          // Clear storage
          if (target.id === 'clear-storage') {
            Storage.clear();
            this.notify('ğŸ—‘ï¸ Local data cleared');
            return;
          }
          
          // App cards
          const appCard = target.closest('.app-card');
          if (appCard) {
            this.openApp(appCard.dataset.app);
            return;
          }
          
          // Back button
          if (target.id === 'back-btn') {
            this.closeApp();
            return;
          }
          
          // Copilot toggle
          if (target.id === 'copilot-toggle') {
            this.toggleCopilot();
            return;
          }
          
          if (target.id === 'cop-close') {
            this.toggleCopilot();
            return;
          }
          
          // AI
          if (target.id === 'ai-send') {
            this.sendAIMessage();
            return;
          }
          
          // YouTube
          if (target.id === 'yt-search') {
            this.searchYouTube();
            return;
          }
          
          const ytVideo = target.closest('.yt-video');
          if (ytVideo) {
            this.playYouTube(ytVideo.dataset.vid);
            return;
          }
          
          // Build
          if (target.id === 'build-run') {
            this.runBuild();
            return;
          }
          
          // Radio
          if (target.id === 'rad-search') {
            this.searchRadio();
            return;
          }
          
          if (target.id === 'rad-toggle') {
            this.toggleRadio();
            return;
          }
          
          const radStation = target.closest('.rad-station');
          if (radStation) {
            this.playRadio(parseInt(radStation.dataset.idx));
            return;
          }
          
          // IDE
          if (target.id === 'ide-run') {
            this.runIDE();
            return;
          }
          
          // Art
          if (target.id === 'art-gen') {
            this.generateArt();
            return;
          }
          
          const artImg = target.closest('.art-img');
          if (artImg) {
            const idx = parseInt(artImg.dataset.idx);
            const url = this.state.artImgs[idx]?.u;
            if (url) window.open(url, '_blank');
            return;
          }
          
          // Tools
          const toolBtn = target.closest('.tool-install');
          if (toolBtn) {
            this.installTool(toolBtn.dataset.tool);
            return;
          }
          
          // Admin
          if (target.id === 'adm-refresh') {
            this.loadAdmin();
            return;
          }
          
          const admBtn = target.closest('.adm-action');
          if (admBtn) {
            const role = admBtn.dataset.role;
            this.adminAction(admBtn.dataset.uid, admBtn.dataset.action, role ? { role } : {});
            return;
          }
          
          // Copilot send
          if (target.id === 'cop-send') {
            this.sendCopilotMessage();
            return;
          }
          
          // Games
          const gameSelect = target.closest('.game-select');
          if (gameSelect) {
            this.selectGame(gameSelect.dataset.game);
            return;
          }
          
          const gameBack = target.closest('.game-back');
          if (gameBack) {
            this.exitGame();
            return;
          }
          
          if (target.id === 'snake-restart') {
            this.startSnake();
            this.render();
            return;
          }
          
          const snakeDir = target.closest('.snake-dir');
          if (snakeDir) {
            this.changeSnakeDirection(snakeDir.dataset.dir);
            return;
          }
          
          const memoryCard = target.closest('.memory-card');
          if (memoryCard && !memoryCard.disabled) {
            this.flipMemoryCard(parseInt(memoryCard.dataset.idx));
            return;
          }
          
          if (target.id === 'memory-restart') {
            this.startMemory();
            this.render();
            return;
          }
          
          if (target.id === 'reaction-box') {
            this.handleReactionClick();
            return;
          }
        });
        
        // Form submissions
        document.addEventListener('submit', (e) => {
          if (e.target.id === 'login-form') {
            e.preventDefault();
            const form = new FormData(e.target);
            this.login(form.get('username'), form.get('password'));
          }
        });
        
        // Key handlers
        document.addEventListener('keydown', (e) => {
          // Snake game controls
          if (this.state.gameType === 'snake' && !this.state.snake.over) {
            const keyMap = {
              'ArrowUp': 'up', 'w': 'up', 'W': 'up',
              'ArrowDown': 'down', 's': 'down', 'S': 'down',
              'ArrowLeft': 'left', 'a': 'left', 'A': 'left',
              'ArrowRight': 'right', 'd': 'right', 'D': 'right'
            };
            if (keyMap[e.key]) {
              e.preventDefault();
              this.changeSnakeDirection(keyMap[e.key]);
              return;
            }
          }
          
          if (e.key === 'Enter') {
            if (e.target.id === 'ai-input') {
              this.sendAIMessage();
            } else if (e.target.id === 'yt-input') {
              this.searchYouTube();
            } else if (e.target.id === 'rad-input') {
              this.searchRadio();
            } else if (e.target.id === 'term-input') {
              this.runTerminalCommand(e.target.value);
              e.target.value = '';
            } else if (e.target.id === 'cop-input') {
              this.sendCopilotMessage();
            } else if (e.target.id === 'art-input') {
              this.generateArt();
            }
          }
        });
        
        // IDE code sync with debounce
        document.addEventListener('input', Utils.debounce((e) => {
          if (e.target.id === 'ide-code') {
            this.state.ideCode = e.target.value;
          }
        }, 300));
        
        // Network status
        window.addEventListener('online', () => {
          this.state.online = true;
          this.notify('ğŸŒ Connection restored');
          this.render();
        });
        
        window.addEventListener('offline', () => {
          this.state.online = false;
          this.notify('âš ï¸ Connection lost');
          this.render();
        });
        
        // Page visibility - cleanup when hidden
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            // Pause snake game when tab is hidden
            if (this.state.gameType === 'snake' && !this.state.snake.over) {
              GameManager.clearInterval('snake');
            }
          } else {
            // Resume when visible
            if (this.state.gameType === 'snake' && !this.state.snake.over) {
              GameManager.setInterval('snake', () => this.moveSnake(), this.state.snake.speed);
            }
          }
        });
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // BOOT
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      async boot() {
        const steps = ['LOADING CORE', 'INITIALIZING AI', 'STARTING SYSTEMS', 'READY'];
        for (let i = 0; i < steps.length; i++) {
          this.state.bootP = ((i + 1) / steps.length) * 100;
          this.state.bootT = steps[i];
          this.render();
          await new Promise(r => setTimeout(r, 500));
        }
        
        // Restore saved state
        const saved = Storage.load();
        if (saved.user) {
          this.state.user = saved.user;
          this.state.phase = 'desktop';
          if (saved.aiMsgs) this.state.aiMsgs = saved.aiMsgs;
          if (saved.ideCode) this.state.ideCode = saved.ideCode;
          this.state.aiMsgs.push({ r: 'assistant', c: `ğŸ‘‹ Welcome back, ${saved.user.displayName}!` });
        } else {
          this.state.phase = 'login';
        }
        this.render();
      },
      
      init() {
        // Initialize particles
        this.initParticles();
        
        // Setup events
        this.setupEvents();
        
        // Clock
        setInterval(() => {
          this.state.time = new Date().toLocaleTimeString('en-US', { hour12: false });
          if (this.state.phase === 'desktop') this.render();
        }, 1000);
        
        // Start
        this.boot();
      }
    };
    
    // Start the OS
    App.init();
  </script>
</body>
</html>
